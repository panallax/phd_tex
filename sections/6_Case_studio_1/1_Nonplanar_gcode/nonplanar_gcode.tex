\documentclass[../../../main.tex]{subfiles}
\begin{document}

Developing G code to print the developed structures in a non-planar manner involves two tasks. 
First, it is necessary to understand how G-code works and what modifications would need to be made to the code in order to unlock the third axis during printing. 
Next, the structure must be analysed in order to develop the printing paths for the structure, which will be used to write the G-code that allows them to be printed.
This subsection will explain each of these parts.

\subsection{Implementation of non-planar G-code}

G-code (abbreviation for geometric code) is the most widely used computer numerical control (CNC) and 3D printing programming language. 
It is used mainly in computer-aided manufacturing to control automated machine tools, as well as for 3D-printer slicer applications.
G-code instructions are provided to a machine controller that tells the motors where to move, how fast to move, and what path to follow. 
There are many commands available, and depending on the machine being used, some may be added or removed. This manuscript is not intended to be a guide to using G-code, so only the commands that have been used for this project will be introduced\footnote{Readers are encouraged to explore G-code commands on their own. It is always recommended to consult the manuals provided by the firmware developer, in this case \href{https://marlinfw.org/meta/gcode/}{Marlin}.}.

A complete G-code consists of three parts: header, body and footer. 
The header and footer, as their names suggest, are located at the beginning and end of the code, respectively. 
The header contains commands for setting up the machine before manufacturing, such as turning on the motors, heating the extruder or bed, turning on the fans, etc. 
The footer contains commands to end the use of the machine, such as moving the extruder to its home position, cooling the extruder, turning off fans, etc. 
Both blocks are usually the same in all G-codes for a user and/or machine.
The body, on the other hand, is different for each design manufactured. 
It includes all the commands that govern the movement of the head.
The commands used in the header and footer will not be explained as they are considered irrelevant to the purpose of this section. 
In the header, the extruder and bed temperatures are set using the M190 and M109 commands, respectively, and a straight line is printed on one of the edges of the bed to clean the extruder. 
In the footer, the extruder is raised to a relative height of 1 cm, moved to its home position, and the machine is turned off.

In G-code, commands are identified by their code, which consists of a letter and several numbers. 
The letters can be G or M, depending on whether they are commands that control the movement of the tool or, conversely, commands intended to control the machine's status, respectively. 
As for the numbers, they start from 0 to the index of the last available command and are generally simultaneous. 
While it is true that many of these numbers are common to all machines that use G code, the firmware manufacturer ultimately decides on these commands, and it is possible that two machines may have different commands and even numbers. 
In this project, the Marlin v1.1.9 firmware has been used, so the commands included will refer to this firmware.

As the structures used for this project are strut-based, i.e. straight lines, only the G0 and G1 commands will be used. 
Both commands are used to perform linear movements of the head.
A linear move traces a straight line from one point to another, ensuring that the specified axes will arrive simultaneously at the given coordinates (by linear interpolation). 
The speed may change over time following an acceleration curve, according to the acceleration and jerk settings of the given axes.
In fact, both commands are the same and are perfectly interchangeable. 
However, the G0 command is conventionally used for linear movements in which the tool, in this case the extruder, is not used, and the G1 command is used for linear movements in which the tool is used.
They are easy to use and support various positional and tool control parameters. 
As the 3D printer used only has three axes, the parameters that can be used are as follows:
\begin{itemize}
    \item \textbf{X <pos>:} An absolute or relative coordinate on the X axis.
    \item \textbf{Y <pos>:} An absolute or relative coordinate on the Y axis.
    \item \textbf{Z <pos>:} An absolute or relative coordinate on the Z axis.
    \item \textbf{F <rate>:} Set the requested movement rate for this move and any following moves. As with other rate parameters, this value is specified in current units per minute.
    \item \textbf{E <pos>:} An absolute or relative coordinate on the E (extruder) axis. The E axis describes the position of the filament in terms of input to the extruder feeder.
\end{itemize}

It is not necessary to use all parameters every time; if a parameter is not included in a command line, the previous status of that parameter will be used. 
For this purpose, a G1 command is typically included in the header to set the feed rate, F, which will be used throughout the entire print job. 
For example, the command G1 F600 indicates that the print speed will be 600 $mm/min$.
The units conventionally used are millimetres, although they can be modified as desired.
To print in a non-planar manner, simply use the three positional parameters in each G1 command. 
Normally, the Z axis is only used to change layers, and only the X and Y axes are used in each layer. 
However, if all three are used at the same time, it is possible to print in the air. 
For example, the command G1 X0.5 Y0.5 Z1 will print one of the edges of a square pyramid with a base of 1 mm and a height of 1 mm.
The values of the positional parameters will depend on whether an absolute (G90) or relative (G91) positioning system is used. 
In an absolute positioning system, the final position of the extruder is determined with respect to the point considered as the origin. 
In the relative positioning system, the origin is positioned at the extruder's location, and displacements are determined by increments along each axis, as shown in \cref{fig:g90g91}.
In this work, absolute positioning was used.
This also affects the extruder axis, E.

\begin{figure}[!htbp]
    \centering
    \input{imgs/g90g91.tex}
    \caption{Example of the use of the absolute coordinate system, in red, and the relative coordinate system, in blue.}
    \label{fig:g90g91}
\end{figure}

The E parameter corresponds to the amount of filament to be extruded during the movement.
This translates into how much the motors that push the filament towards the extruder have to rotate. 
Generally, to calculate this parameter, it is necessary to calculate the volume of the rectangular prism that is generated when the molten filament exits the extruder and is pressed against the base. 
However, in non-planar printing, this does not happen; instead, the material maintains the same cylindrical shape as it exits. 
Therefore, to calculate this parameter, the volume of the cylinder to be printed must be calculated, see \cref{fig:no_planar}. 

\begin{figure}[!htbp]
    \centering
    \input{imgs/no_planar.tex}
    \caption{Illustration of extruded material in planar printing (left) and non-planar printing (right).}
    \label{fig:no_planar}
\end{figure}

Since the diameter of the extruder is fixed, the diameter of the printed cylinder will also be constant. 
This is one of the main drawbacks of this type of printing: to modify the thickness of the cylinders, the diameter of the extruder must be modified. 
As mentioned above, this parameter acts on the motors that push the filament, so the value must be given in relation to the amount of filament that needs to be pushed. 
Therefore, this value is obtained by conserving the mass in the extruder's control volume.
Given the control volume defined in \cref{fig:E}, the amount of material passing through interface $e_1$ must be equal to that passing through interface $e_2$, since the rest of the interfaces are solid.

\begin{figure}[!htbp]
    \centering
    \input{imgs/E.tex}
    \caption{Schematic section of a 3D printing extruder. The molten filament is shown in blue and the extruder in orange.}
    \label{fig:E}
\end{figure}

Where $D_f$ is the diameter of the filament and $d_e$ is the diameter of the extruder, the following relationship can be used:
\[
V_f = V_e.
\]
Where
\begin{align*}
V_{f} = E \cdot \frac{\pi D_f^2}{4} \\
V_{e} = \Delta L \cdot \frac{\pi d_e^2}{4}
\end{align*}
Let E be the extrusion parameter sought and $\Delta L$ be the length of the cylinder to extrude. 
If both expressions are equated, the expression for parameter E for non-planar printing can be obtained:

\[
\boxed{E = \Delta L \cdot \frac{d_e^2}{D_f^2}}
\]

This expression is valid regardless of the type of extruder used.
The filament diameter most commonly used in personal printers is 1.75 \textit{mm}, which is the one used in this project. 
As for the extruder, the most common in personal printers is 0.4 \textit{mm}, although various types have been used in this project. 
However, in any case, both parameters are constant, so it is only necessary to know the length of the cylinder to be printed to obtain the E parameter. 
Additionally, this parameter is usually multiplied by another value called flow rate (FR $\in [0,1]$), which is used to modify the value of E if the amount to be extruded needs to be reduced.

\subsection{Strategy for defining printing paths}

Once we have explained how to instruct the printer to print in a non-planar manner, the next objective is to establish the paths that the extruder must follow to print the structure.     

Given that the skeleton of the structure is stored as a graph, graph theory could be used to traverse the graph under certain conditions and thus establish these paths.  
For example, finding the shortest paths that travel through the graph. 
The structure could even be divided into generations of tetrahedra (layers), and the same paths could be searched for between each of the generations. 
The latter method is more viable as it allows the structure to grow gradually, preventing the printer head from colliding with already printed parts if one of the paths found crosses several layers. 
Therefore, the paths should traverse ascending and then descending edges to print the structure continuously. 
There are various graph search algorithms that allow these paths to be found, such as the A* algorithm, Breadth First Search or Depth First Search. 
All of them can include heuristic functions that penalise nodes that prevent the extruder from changing its vertical printing direction. 
Although it is mathematically feasible to find these paths, it is physically unfeasible to use them to print the structure.

It must be kept in mind that the filament inside the extruder is molten, so it behaves like a highly viscous liquid, and once it leaves the extruder, it begins to solidify. Both states are linked by a transition zone just at the extruder outlet, where the polymer will behave viscoelastically, see \cref{fig:no_paths}. The length of this zone will depend on the temperature of the extruder, the ambient temperature and the extrusion speed, and cannot be zero. Determining the length of this zone involves solving a very complex thermodynamic problem, but assuming the filament is a continuous cylindrical body moving at constant speed \( V_f \) in air, a simplified model can be described by equating the heat loss by convection to the internal energy change:

\begin{figure}[!htbp]
    \centering
    \input{imgs/no_paths.tex}
    \caption{Schematic illustration of the transition zone of the polymer.}
    \label{fig:no_paths}
\end{figure}

\[
\frac{dQ}{dx} = h_c \cdot A_s \cdot \left( T(x) - T_{\text{air}} \right)
\]

\[
\frac{dQ}{dx} = \rho A c_p V_f \cdot \frac{dT}{dx}
\]

Where:
\begin{itemize}
  \item \( h_c \): convective heat transfer coefficient [W/m\(^2\)K]
  \item \( A_s \): surface area per unit length of the filament (\( \approx 2\pi r \))
  \item \( A \): cross-sectional area of the filament (\( \pi r^2 \))
  \item \( \rho \): density of the material [kg/m\(^3\)]
  \item \( c_p \): specific heat capacity [J/kgÂ·K]
  \item \( V_f \): feed rate [m/s]
  \item \( T(x) \): temperature of the filament at position \( x \)
  \item \( T_{\text{air}} \): ambient air temperature
\end{itemize}

Equating the two expressions:

\[
\rho A c_p V_f \cdot \frac{dT}{dx} = - h_c A_s \cdot \left( T(x) - T_{\text{air}} \right)
\]

Cancelling the geometry (since \( A_s/A = 2/r \)), we get:

\[
\frac{dT}{dx} = -\frac{h_c A_s}{\rho A c_p V_f} (T - T_{\text{air}}) = -\frac{h_c'}{\rho c_p V_f} (T - T_{\text{air}})
\]

Defining the cooling length scale:

\[
\lambda = \frac{\rho c_p V_f}{h_c'}
\]

This leads to the differential equation:

\[
\frac{dT}{dx} = -\frac{1}{\lambda} (T - T_{\text{air}})
\]

This is a standard first-order linear differential equation. Its solution is:

\[
T(x) = T_{\text{air}} + (T_0 - T_{\text{air}}) e^{-x / \lambda}
\]

Where \( T_0 = T_{\text{extrusion}} \) is the initial temperature at \( x = 0 \).
The length of the transition zone \( L_{\text{trans}} \) can be defined as the distance at which the temperature reaches the solidification temperature \( T_{\text{solid}} \). Setting:

\[
T(L_{\text{trans}}) = T_{\text{solid}}
\]

\[
T_{\text{solid}} = T_{\text{air}} + (T_{\text{extrusion}} - T_{\text{air}}) e^{-L_{\text{trans}} / \lambda}
\]

Solving for \( L_{\text{trans}} \):

\[
e^{-L_{\text{trans}} / \lambda} = \frac{T_{\text{solid}} - T_{\text{air}}}{T_{\text{extrusion}} - T_{\text{air}}}
\Rightarrow
L_{\text{trans}} = \lambda \cdot \ln\left( \frac{T_{\text{extrusion}} - T_{\text{air}}}{T_{\text{solid}} - T_{\text{air}}} \right)
\]

Finally, substituting \( \lambda \):

\[
L_{\text{trans}} \simeq \frac{\rho c_p V_f}{h_c'} \cdot \ln\left( \frac{T_{\text{extrusion}} - T_{\text{air}}}{T_{\text{solid}} - T_{\text{air}}} \right)
\]

For example, for PLA, this transition zone can vary between 4 - 10 \textit{mm} according to this simplified model, depending on the printing conditions.

The existence of this transition zone will cause a narrowing in this area during upward movements, as the extruder will exert a dragging force, $F_d$, in the direction of travel and the solid area will exert an equal and opposite adhesive force, $F_a$, see \cref{fig:bending_edges} \textcolor{blue}{(a)}. 
If the adhesive force is not sufficient, the edge will detach from the base. 
During upward movement, this is not very problematic because if the printing speed is slowed down sufficiently, the length of the transition zone can be significantly reduced, and there will be almost no narrowing at the edges. 
The biggest problem arises during downward movements. 
In these cases, a torsional moment, $M_t$, also appears at the base of the ascending edge, causing the material in the transition zone to bend, see \cref{fig:bending_edges} \textcolor{blue}{(b)}. 
As the length of the descending edge increases, the moment becomes greater, and there comes a point where the adhesion force is not sufficient to counteract it, and the edge will collapse, \cref{fig:bending_edges} \textcolor{blue}{(c)}. 
This will happen regardless of the printing speed because $L_{trans}$ cannot be zero, and during the descent, it will be greater because the hot walls of the extruder will be in direct contact with the solid descending edge, causing it to heat up. 
Therefore, it is not possible to print descending edges with only three degrees of freedom in the extruder. 
For this reason, it is physically impossible to use a strategy based on graph search algorithms to create the print paths. The method used can only print ascending edges.

\begin{figure}[!htbp]
    \centering
    \input{imgs/bending_edges.tex}
    \caption{Schematic illustration of the evolution of the state of an edge printed upwards and then downwards.}
    \label{fig:bending_edges}
\end{figure}


Therefore, it was decided to divide the structure by generations and print each of the tetrahedra that comprises them individually. 
This way, each edge is printed in ascending order. 
As the layers are composed of tetrahedra of varying shapes and heights, a method must be devised that enables them to be printed without collapsing onto previously printed parts due to collisions with the print head. 
To do this, the tetrahedra are sorted according to their height and printed from the lowest to the highest. 
This may not guarantee that the print head will not collide with the printed parts, but it does guarantee that if there are any collisions, they will be as few as possible. 
For example, in \cref{fig:printing_tets} \textcolor{blue}{(a)}, printing the triangle on the right first could cause the print head to collide with that pyramid three times, once for each edge printed after the first. 
However, if the one on the left is printed first, it could only collide once; once the small triangle is printed, it cannot collide with it again. 
The probability of collision will depend on the length of the tetrahedra and the length of the extruder. 
For this reason, the longer the extruder, the better. 
It is also necessary to clarify the printing order of each of the edges of a tetrahedron. 
As there may be tetrahedra with internal edges, it is always better to print those edges first. 
Otherwise, the head would collide with the outer edges that have already been printed. 
Therefore, it was decided that the order of the edges would depend on the distance from the base of each edge to the projection of the tetrahedron's vertex on the base, see \cref{fig:printing_tets} \textcolor{blue}{(b)}.

\begin{figure}[!htbp]
    \centering
    \input{imgs/printing_tets.tex}
    \caption{A) Illustration of two adjacent triangles of different heights. B) Example of the order of printing the edges of a tetrahedron.}
    \label{fig:printing_tets}
\end{figure}

Before printing the tetrahedra, the base on which they will be printed must be printed. 
It will lie flat on the bed and will therefore be printed in a planar way. 
The base will always be a Delaunay triangulation of the points that compose the base. 
In order to optimise printing time, a depth-first search algorithm was used to obtain the longest paths that allow the base to be printed without repeating an edge. 
The longer the paths, the less time will be lost in repositioning the print head. 
Once the paths have been obtained, four layers will be printed with a layer height equivalent to half the diameter of the extruder. 
Printing four layers on the base will cause the position of the nodes to be different. 
Initially, the tetrahedra of the base have their base points at z = 0 \textit{mm}, but after printing the four layers, they must be moved to z = 0.8 \textit{mm} for an extruder with a diameter of 0.4 \textit{mm}. 
If this is not done, the extruder will pass through the four layers when printing the edges, breaking them.
This displacement must therefore be transmitted to all nodes of the structure. 
Then, all the print paths for all the edges are generated according to the order mentioned above.

\end{document}